<!DOCTYPE html>
<html lang="fr">
<head>
    <title>Liaison Points d'Énergie</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            font-family: Monospace;
            background-color: #BD786C;
            color: #fff;
            margin: 0px;
            overflow: hidden;
        }
        .label {
            color: #fff;
            background-color: rgba(0,0,0,0.5);
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 12px;
            pointer-events: none;
            white-space: nowrap;
        }
    </style>
</head>
<body id="acu">
    <script src="three/build/three.js"></script>
    <script src="three/loaders/OBJLoader.js"></script>
    <script src="three/controls/OrbitControls.js"></script>
    <script src="three/examples/js/renderers/CSS2DRenderer.js"></script>

    <script>
        // Variables globales
        let container, camera, scene, renderer, labelRenderer, controls;
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        let mouseX = 0, mouseY = 0;
        let windowHalfX = window.innerWidth / 2;
        let windowHalfY = window.innerHeight / 2;
        let acuX = 0, acuY = 0, acuZ = 0;
        let acuXF = 0, acuYF = 0, acuZF = 0;
        let focoCamera = false;
        let p = new THREE.Vector3(0, 0, 0);
        let obj_aux = null;

        const labels = [];
        let lastClickedPoint = null;

        // Initialisation des écouteurs pour les points d'acupression
        function initEventListeners() {
            const meridianPoints = [
                { id: 'p', count: 11 },
                { id: 'gi', count: 20 },
                { id: 'e', count: 45 },
                { id: 'rp', count: 21 },
                { id: 'c', count: 9 },
                { id: 'ig', count: 19 },
                { id: 'v', count: 67 },
                { id: 'r', count: 27 },
                { id: 'pc', count: 9 },
                { id: 'tr', count: 23 },
                { id: 'vb', count: 44 },
                { id: 'f', count: 14 },
                { id: 'vg', count: 28 },
                { id: 'vc', count: 24 },
                { id: 'cs', count: 1 }
            ];

            meridianPoints.forEach(meridian => {
                for (let i = 1; i <= meridian.count; i++) {
                    const pointId = `${meridian.id}${i}`;
                    const element = parent.document.getElementById(pointId);
                    if (element) {
                        element.onclick = () => acuPonto(pointId);
                    }
                }
            });
        }

        // Création d'une sphère avec label
        function createSphere(name, color, x, y, z, view = null) {
            const geometry = new THREE.SphereGeometry(0.3, 32, 32);
            const material = new THREE.MeshLambertMaterial({ color });
            const object = new THREE.Mesh(geometry, material);
            object.name = name;
            object.position.set(x, y, z);
            if (view !== null) object.view = view;
            scene.add(object);

            // Création du label
            const div = document.createElement('div');
            div.className = 'label';
            div.textContent = name;
            const label = new THREE.CSS2DObject(div);
            label.position.set(0, 0.5, 0);
            object.add(label);
            labels.push(label);
        }

        // Initialisation de la scène
        function init() {
            container = document.createElement('div');
            document.body.appendChild(container);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.5, 2000);
            camera.position.z = 250;

            controls = new THREE.OrbitControls(camera);
            controls.dampingFactor = 0.2;
            controls.addEventListener('change', render);

            scene = new THREE.Scene();

            const ambient = new THREE.AmbientLight(0x101030);
            scene.add(ambient);

            const directionalLight1 = new THREE.DirectionalLight(0xffeedd);
            directionalLight1.position.set(0, 0, 1);
            scene.add(directionalLight1);

            const directionalLight2 = new THREE.DirectionalLight(0xffeedd);
            directionalLight2.position.set(0, 0, -1);
            scene.add(directionalLight2);

            // Création des sphères
            createSphere('cs7', Math.random() * 0x0000FF, -24.71516683000315, -6.555406638283143, 0.6);

            // Vaisseaux Conception
            const vcPositions = [
                { name: 'vc1', x: 0.05, y: -12.7, z: -4.2 },
                { name: 'vc2', x: 0.05, y: -6, z: 6.4 },
                { name: 'vc3', x: 0.05, y: -2.9, z: 7.1 },
                { name: 'vc4', x: 0.05, y: 0.20000000000000018, z: 7.17 },
                { name: 'vc5', x: 0.05, y: 3.3000000000000007, z: 7.25 },
                { name: 'vc6', x: 0.05, y: 6.4, z: 7.3 },
                { name: 'vc7', x: 0.05, y: 9.5, z: 7.2 },
                { name: 'vc8', x: 0.05, y: 12.7, z: 6.1 },
                { name: 'vc9', x: 0.05, y: 15.9, z: 6.1 },
                { name: 'vc10', x: 0.05, y: 18.4, z: 6.38 },
                { name: 'vc11', x: 0.05, y: 20.9, z: 6.38 },
                { name: 'vc12', x: 0.05, y: 23.4, z: 6.58 },
                { name: 'vc13', x: 0.05, y: 25.9, z: 6.6 },
                { name: 'vc14', x: 0.05, y: 28.4, z: 5.95 },
                { name: 'vc15', x: 0.05, y: 30.9, z: 5.06 },
                { name: 'vc16', x: 0.05, y: 33.4, z: 4.9 },
                { name: 'vc17', x: 0.05, y: 36, z: 4.7 },
                { name: 'vc18', x: 0.05, y: 38.6, z: 3.6 },
                { name: 'vc19', x: 0.05, y: 41.2, z: 2.4 },
                { name: 'vc20', x: 0.05, y: 43.8, z: 1.2 },
                { name: 'vc21', x: 0.05, y: 46.4, z: -0.9 },
                { name: 'vc22', x: 0.05, y: 49, z: -2.1 },
                { name: 'vc23', x: 0.02, y: 56, z: -0.2 },
                { name: 'vc24', x: 0.02, y: 60, z: 5 }
            ];

            vcPositions.forEach(pos => {
                createSphere(pos.name, 0x9370DB, pos.x, pos.y, pos.z);
            });

            // Poumon
            const pPositions = [
                { name: 'p1', x: -13.267798006864483, y: 46.00000000000004, z: -1.0999999999999999 },
                { name: 'p2', x: -11.26779800686449, y: 48.60000000000008, z: -3.4000000000000026 },
                { name: 'p3', x: -22.967798006864573, y: 32.39999999999985, z: -4.7 },
                { name: 'p4', x: -23.56779800686458, y: 28.699999999999797, z: -4.999999999999999 },
                { name: 'p5', x: -24.16779800686459, y: 15.69999999999962, z: -4.6000000000000005 },
                { name: 'p6', x: -25.767798006864613, y: 7.499999999999648, z: -2.7000000000000015 },
                { name: 'p7', x: -26.96779800686463, y: -1.5000000000003426, z: -1.5000000000000004 },
                { name: 'p8', x: -26.26779800686462, y: -3.500000000000344, z: -0.5000000000000001 },
                { name: 'p9', x: -27.367798006864636, y: -5.500000000000339, z: -0.30000000000000016 },
                { name: 'p10', x: -27.66779800686464, y: -7.7000000000003315, z: 2.1000000000000005 },
                { name: 'p11', x: -30.56779800686468, y: -13.200000000000312, z: 5.999999999999995 }
            ];

            pPositions.forEach(pos => {
                createSphere(pos.name, 0xf5f5f0, pos.x, pos.y, pos.z);
            });

            // Gros Intestin
            const igPositions = [
                { name: 'gi1', x: 29.232201993135632, y: -20.00000000000036, z: 6.199999999999994, view: 1 },
                { name: 'gi2', x: 29.332201993135634, y: -14.700000000000307, z: 2.8000000000000007, view: 1 },
                { name: 'gi3', x: 29.532201993135637, y: -12.200000000000315, z: 1.7999999999999998, view: 1 },
                { name: 'gi4', x: 29.532201993135637, y: -10.500000000000322, z: 0.39999999999999936, view: -2 },
                { name: 'gi5', x: 28.33220199313562, y: -6.800000000000335, z: 0.39999999999999925, view: 1 },
                { name: 'gi6', x: 28.032201993135615, y: -0.3000000000003421, z: -3.8000000000000025, view: 1 },
                { name: 'gi7', x: 27.832201993135612, y: 4.399999999999659, z: -6.399999999999994, view: 1 },
                { name: 'gi8', x: 27.73220199313561, y: 9.69999999999964, z: -8.099999999999989, view: 1 },
                { name: 'gi9', x: 27.532201993135608, y: 11.999999999999632, z: -8.799999999999986, view: 1 },
                { name: 'gi10', x: 27.232201993135604, y: 14.299999999999624, z: -9.299999999999985, view: 1 },
                { name: 'gi11', x: 27.0322019931356, y: 17.59999999999964, z: -8.799999999999986, view: 1 },
                { name: 'gi12', x: 26.632201993135595, y: 20.49999999999968, z: -8.599999999999987, view: 1 },
                { name: 'gi13', x: 26.432201993135592, y: 23.499999999999723, z: -9.299999999999985, view: 1 },
                { name: 'gi14', x: 24.73220199313557, y: 33.29999999999986, z: -7.599999999999991, view: 1 },
                { name: 'gi15', x: 20.432201993135507, y: 47.20000000000006, z: -5, view: 1 },
                { name: 'ig16', x: 18.132201993135475, y: 48.80000000000008, z: -6.499999999999995, view: 1 },
                { name: 'gi17', x: 5.532201993135482, y: 54.10000000000016, z: -4.0000000000000036 },
                { name: 'gi18', x: 5.132201993135483, y: 56.100000000000186, z: -3.600000000000003 },
                { name: 'gi19', x: 0.9322019931354847, y: 62.400000000000276, z: 4.899999999999998 },
                { name: 'gi20', x: 1.9322019931354855, y: 62.90000000000028, z: 4.3 }
            ];

            igPositions.forEach(pos => {
                createSphere(pos.name, 0x00CED1, pos.x, pos.y, pos.z, pos.view);
            });

            // Estomac
            const ePositions = [
                { name: 'e1', x: -2.9677980068645167, y: 66.70000000000014, z: 3 },
                { name: 'e2', x: -2.9677980068645167, y: 66.00000000000018, z: 3.2 },
                { name: 'e3', x: -2.8677980068645166, y: 63.700000000000294, z: 3.8000000000000007 },
                { name: 'e4', x: -2.7677980068645165, y: 61.10000000000026, z: 4.1000000000000005 },
                { name: 'e5', x: -3.367798006864517, y: 58.200000000000216, z: 2.4999999999999996, view: -1 },
                { name: 'e6', x: -5.967798006864511, y: 61.30000000000026, z: -2.6000000000000028, view: -1 },
                { name: 'e7', x: -6.467798006864509, y: 64.20000000000029, z: -2.700000000000003, view: -1 },
                { name: 'e8', x: -6.26779800686451, y: 71.89999999999985, z: -2.700000000000003, view: -1 },
                { name: 'e9', x: -2.9677980068645167, y: 54.20000000000016, z: -2.3000000000000025 },
                { name: 'e10', x: -2.267798006864516, y: 51.40000000000012, z: -2.2000000000000024 },
                { name: 'e11', x: -2.9677980068645167, y: 47.600000000000065, z: -1.2000000000000015 },
                { name: 'e12', x: -6.667798006864508, y: 48.60000000000008, z: -2.2000000000000024 },
                { name: 'e13', x: -7.067798006864507, y: 47.600000000000065, z: -1.0000000000000013 },
                { name: 'e14', x: -7.667798006864505, y: 44.800000000000026, z: 0.8999999999999986 },
                { name: 'e15', x: -8.767798006864501, y: 42.29999999999999, z: 2.3999999999999995 },
                { name: 'e16', x: -9.867798006864497, y: 38.89999999999994, z: 4.2 },
                { name: 'e17', x: -12.06779800686449, y: 33.19999999999986, z: 4.999999999999997 },
                { name: 'e18', x: -12.06779800686449, y: 30.199999999999818, z: 2.1999999999999993 },
                { name: 'e19', x: -3.167798006864517, y: 25.699999999999754, z: 6.599999999999992 },
                { name: 'e20', x: -3.167798006864517, y: 22.64727272727248, z: 6.699999999999991 },
                { name: 'e21', x: -3.167798006864517, y: 19.59454545454521, z: 6.699999999999991 },
                { name: 'e22', x: -3.167798006864517, y: 16.541818181817938, z: 6.499999999999992 },
                { name: 'e23', x: -3.167798006864517, y: 13.489090909090663, z: 6.699999999999991 },
                { name: 'e24', x: -3.167798006864517, y: 10.43636363636339, z: 7.09999999999999 },
                { name: 'e25', x: -3.167798006864517, y: 7.383636363636118, z: 6.99999999999999 },
                { name: 'e26', x: -3.167798006864517, y: 4.330909090908847, z: 6.899999999999991 },
                { name: 'e27', x: -3.167798006864517, y: 1.2781818181815723, z: 6.599999999999992 },
                { name: 'e28', x: -3.167798006864517, y: -1.7745454545457022, z: 6.299999999999993 },
                { name: 'e29', x: -3.167798006864517, y: -4.827272727272973, z: 5.699999999999995 },
                { name: 'e30', x: -3.167798006864517, y: -7.880000000000244, z: 4.599999999999999 },
                { name: 'e31', x: -12.467798006864488, y: -11.280000000000232, z: 4.100000000000001 },
                { name: 'e32', x: -12.467798006864488, y: -28.48000000000039, z: 4.300000000000001 },
                { name: 'e33', x: -12.467798006864488, y: -36.2800000000005, z: 2.900000000000001 },
                { name: 'e34', x: -12.467798006864488, y: -38.98000000000054, z: 2.3000000000000003 },
                { name: 'e35', x: -12.467798006864488, y: -47.18000000000065, z: 1.4999999999999996 },
                { name: 'e36', x: -12.467798006864488, y: -53.18000000000074, z: -0.10000000000000153 },
                { name: 'e37', x: -12.467798006864488, y: -63.68000000000089, z: -0.7000000000000015 },
                { name: 'e38', x: -11.76779800686449, y: -69.78000000000057, z: -1.6000000000000019 },
                { name: 'e39', x: -11.367798006864492, y: -73.28000000000037, z: -1.9000000000000021 },
                { name: 'e40', x: -13.467798006864484, y: -69.48000000000059, z: -4.3000000000000025, view: -1 },
                { name: 'e41', x: -8.667798006864501, y: -85.1799999999997, z: -0.8000000000000016 },
                { name: 'e42', x: -9.967798006864497, y: -88.27999999999952, z: 0.9999999999999983 },
                { name: 'e43', x: -8.8677980068645, y: -90.97999999999936, z: 6.099999999999993 },
                { name: 'e44', x: -9.467798006864498, y: -91.87999999999931, z: 7.799999999999988 },
                { name: 'e45', x: -9.967798006864497, y: -93.17999999999924, z: 11.299999999999976 }
            ];

            ePositions.forEach(pos => {
                createSphere(pos.name, 0xFFD700, pos.x, pos.y, pos.z, pos.view);
            });

             // Chargement OBJ
            const manager = new THREE.LoadingManager();
            const texture = new THREE.Texture();
            const loaderImage = new THREE.ImageLoader(manager);
            loaderImage.load('three/textura/UV_Grid_Sm.jpg', image => {
                texture.image = image;
                texture.needsUpdate = true;
            });

            const loaderObj = new THREE.OBJLoader(manager);
            loaderObj.load('three/modelo/corpo.obj', object => {
                object.traverse(child => {
                    if (child instanceof THREE.Mesh) {
                        child.material.map = texture;
                    }
                });
                object.position.y = -95;
                scene.add(object);
            });

            renderer = new THREE.WebGLRenderer();
            renderer.setClearColor(0xBD786C);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            labelRenderer = new THREE.CSS2DRenderer();
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.domElement.style.position = 'absolute';
            labelRenderer.domElement.style.top = '0px';
            labelRenderer.domElement.style.pointerEvents = 'none';
            container.appendChild(labelRenderer.domElement);

            window.addEventListener('resize', onWindowResize);
            window.addEventListener('mousemove', onDocumentMouseMove);
            window.addEventListener('click', onDocumentClick);
        }

        function onWindowResize() {
            windowHalfX = window.innerWidth / 2;
            windowHalfY = window.innerHeight / 2;
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
        }

        function onDocumentMouseMove(event) {
            event.preventDefault();
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            mouseX = (event.clientX - windowHalfX) / 2;
            mouseY = (event.clientY - windowHalfY) / 2;
        }

        function onDocumentClick(event) {
            event.preventDefault();
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);

            if (intersects.length > 0) {
                const clickedObject = intersects[0].object;

                if (lastClickedPoint && lastClickedPoint !== clickedObject) {
                    lastClickedPoint.material.color.setHex(lastClickedPoint.originalColor);
                }
                if (!clickedObject.originalColor) clickedObject.originalColor = clickedObject.material.color.getHex();
                clickedObject.material.color.setHex(0xFF0000);
                lastClickedPoint = clickedObject;

                const mer = clickedObject.name.replace(/[0-9]+/, '');
                parent.document.getElementById(mer)?.click();
                parent.document.getElementById(clickedObject.name)?.click();

                window.parent.postMessage({ type: 'selectPoint', point: clickedObject.name }, '*');
            }
        }

        function acuPonto(pto) {
            if (obj_aux) obj_aux.material.emissive.setHex(obj_aux.currentHex || 0);

            const obj = scene.getObjectByName(pto);
            if (!obj) return;

            obj.currentHex = obj.material.emissive.getHex();
            obj.material.emissive.setHex(0xff0000);
            obj_aux = obj;

            acuX = obj.position.x;
            acuY = obj.position.y;
            acuZ = obj.position.z;

            acuXF = 0;
            acuYF = 0;
            acuZF = 0;

            if (obj.view === 1) acuXF = 45;
            else if (obj.view === -1) acuXF = -45;
            else if (obj.view === -2) acuZF = -45;
            else acuZF = 45;

            p.set(acuX, acuY, acuZ);
            focoCamera = true;
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            render();
            labelRenderer.render(scene, camera);
        }

        function render() {
            renderer.render(scene, camera);

            if (focoCamera) {
                camera.position.x += (acuX + acuXF - camera.position.x) / 10;
                camera.position.y += (acuY - camera.position.y) / 10;
                camera.position.z += (acuZ + acuZF - camera.position.z) / 10;

                camera.lookAt(p);

                if (Math.round(camera.position.x) === Math.round(acuX + acuXF) &&
                    Math.round(camera.position.y) === Math.round(acuY) &&
                    Math.round(camera.position.z) === Math.round(acuZ + acuZF)) {
                    acuXF = 0; acuYF = 0; acuZF = 0;
                    focoCamera = false;
                    controls.target = p;
                }
            }
        }

        // Lancement
        init();
        initEventListeners();
        animate();
    </script>
</body>
</html>
