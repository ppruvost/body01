<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Energy Points Connection</title>

<style>
body {
    margin: 0;
    overflow: hidden;
    background-color: #BD786C;
    font-family: monospace;
}
#pointLabel {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%) rotate(-90deg);
    color: #3a2d27;
    z-index: 9999;
}
.point-name { font-weight: bold; font-size:18px; }
</style>
</head>

<body>
<div id="pointLabel"></div>

<script src="three/build/three.js"></script>
<script src="three/loaders/OBJLoader.js"></script>
<script src="three/controls/OrbitControls.js"></script>
<script src="js/acu_point.js"></script>
<script src="js/precomputeMeridians.js"></script>

<script>

/* ================= GLOBAL ================= */

var container, camera, scene, renderer, controls;
var raycaster = new THREE.Raycaster();
var mouse = new THREE.Vector2();
var clickableObjects = [];
var bodyMesh = null;
var cameraOffsetX = 0;
var cameraOffsetZ = 45;
var lastSelectedPoint = null;
var curvesData = {};

var sphereGeometry = new THREE.SphereGeometry(0.3,16,16);

/* ================= COLORS ================= */

function getMeridianColor(meridian) {
    const colors = {
        "Maître Coeur": 0x0000FF,
        "Poumon": 0xf5f5f0,
        "Gros Intestin": 0x00CED1,
        "Estomac": 0xFFD700,
        "Rate": 0xF4D03F,
        "Cœur": 0xFF0000,
        "Intestin Grele": 0xFF4500,
        "Vessie": 0x1E90FF,
        "Rein": 0x00008B,
        "Foie": 0x228B22,
        "Vesicule Biliaire": 0x32CD32,
        "Vaisseau Conception": 0x9370DB,
        "Vaisseau Gouverneur": 0x8B0000
    };
    return colors[meridian] || 0xffffff;
}

/* ================= POINTS ================= */

function createPointMesh(point) {
    const material = new THREE.MeshLambertMaterial({
        color: getMeridianColor(point.meridian)
    });

    const mesh = new THREE.Mesh(sphereGeometry, material);
    mesh.name = point.name;
    mesh.position.set(point.x, point.y, point.z);
    mesh.meridian = point.meridian;
    mesh.view = point.view || 0;
    mesh.originalColor = material.color.getHex();

    scene.add(mesh);
    clickableObjects.push(mesh);
}

/* ================= INIT ================= */

function init() {

    container = document.createElement('div');
    document.body.appendChild(container);

    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.5, 2000);
    camera.position.z = 250;

    controls = new THREE.OrbitControls(camera);
    controls.enableRotate = true;
    controls.enableZoom = true;
    controls.enablePan = true;
    controls.enableDamping = true;       // rotation fluide
    controls.dampingFactor = 0.08;

    controls.rotateSpeed = 0.8;
    controls.zoomSpeed = 1.2;
    controls.panSpeed = 0.8;

    controls.minDistance = 40;           // limite zoom proche
    controls.maxDistance = 600;          // limite zoom loin

    controls.target.set(0, 0, 0);        // centre du modèle
    controls.update();

    /* Ombre sur le corps*/
    scene.add(new THREE.AmbientLight(0x101030));

    const d1 = new THREE.DirectionalLight(0xffeedd);
    d1.position.set(0,0,1);
    scene.add(d1);

    const d2 = new THREE.DirectionalLight(0xffeedd);
    d2.position.set(0,0,-1);
    scene.add(d2);

    /* Points */   
    ACU_POINTS.forEach(p => createPointMesh(p));

    /* Meridian Lines */
    buildMeridianLines(scene);

    /* OBJ */
    const loaderObj = new THREE.OBJLoader();
    loaderObj.load('three/modelo/corpo.obj', obj => {
        obj.position.y = -95;
        bodyMesh = obj;
        scene.add(obj);
    });

    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setClearColor(0xBD786C);
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);

    window.addEventListener('resize', onWindowResize);
    window.addEventListener('mousemove', onMouseMove);
    window.addEventListener('click', onMouseClick);
}

/* ================= EVENTS ================= */

function onWindowResize() {
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

function onMouseMove(event) {
    mouse.x = (event.clientX/window.innerWidth)*2-1;
    mouse.y = -(event.clientY/window.innerHeight)*2+1;
}

function onMouseClick() {
    raycaster.setFromCamera(mouse,camera);
    const intersects = raycaster.intersectObjects(clickableObjects);

    if(!intersects.length) return;

    const selected = intersects[0].object;

    const label = document.getElementById("pointLabel");

    /*=======Affichage du point sélectionné======*/
label.innerHTML = `
    <div class="energy-wrapper">
        <div class="energy-card">
            <div class="point-name">${selected.name.toUpperCase()}</div>
            <div class="energy-line"></div>
            <div class="copyright">© bien-etre-geobiologie.fr</div>
        </div>
    </div>
`;

        // Positionnement à gauche
        label.style.position = "fixed";
        label.style.left = "30px";
        label.style.top = "50%";
        label.style.transform = "translateY(-50%)";
        label.style.zIndex = "1000";
        label.style.pointerEvents = "none";

        // Injection style énergétique avancé
        const style = document.createElement("style");
        style.innerHTML = `

        .energy-wrapper {
        position: relative;
        display: inline-block;
        }

        /* Halo énergétique */
        .energy-wrapper::before {
        content: "";
        position: absolute;
        inset: -15px;
        border-radius: 30px;
        background: radial-gradient(
            circle,
            rgba(128,102,91,0.25) 0%,
            rgba(128,102,91,0.12) 40%,
            rgba(128,102,91,0.05) 60%,
            transparent 75%
        );
        z-index: -1;
        animation: energyPulse 4s ease-in-out infinite;
    }

    /* Cartouche */
    .energy-card {
        background: rgba(231, 223, 211, 0.92);
        padding: 18px 24px;
        border-radius: 18px;
        border: 1px solid rgba(128, 102, 91, 0.35);
        box-shadow: 0 0 18px rgba(128, 102, 91, 0.2);
        backdrop-filter: blur(6px);
        font-family: "Cormorant Garamond", serif;
        color: #3a2d27;
        min-width: 190px;
        animation: fadeEnergy 0.6s ease-out;
    }

    .point-name {
        font-size: 20px;
        letter-spacing: 1.5px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .energy-line {
        height: 1px;
        width: 60%;
        background: linear-gradient(
            to right,
            transparent,
            #80665b,
            transparent
        );
        margin: 8px 0 12px 0;
    }

    .copyright {
        font-size: 11px;
        opacity: 0.6;
        letter-spacing: 1px;
    }

    /* Animation apparition */
    @keyframes fadeEnergy {
        from { opacity: 0; transform: translateX(-15px); }
        to { opacity: 1; transform: translateX(0); }
    }

    /* Pulsation énergétique */
    @keyframes energyPulse {
        0% {
            transform: scale(1);
            opacity: 0.6;
        }
        50% {
            transform: scale(1.05);
            opacity: 0.9;
        }
        100% {
            transform: scale(1);
            opacity: 0.6;
        }
    }

    `;
    /*Fin Affichage du point sélectionné*/

document.head.appendChild(style);


    if(lastSelectedPoint)
        lastSelectedPoint.material.color.setHex(lastSelectedPoint.originalColor);

    selected.material.color.setHex(0xffff00);
    lastSelectedPoint = selected;

    focusOnPoint(selected);
    openSubMenu(selected.name);
}

/* ================= CAMERA ================= */

function focusOnPoint(object){

    const newTarget = object.position.clone();

    controls.target.copy(newTarget);

    camera.position.set(
        newTarget.x + cameraOffsetX,
        newTarget.y + 20,
        newTarget.z + cameraOffsetZ
    );

    controls.update();
}


/* ================= MENU ================= */
function openSubMenu(pointName){

    // envoie l’info à index.html
    window.parent.postMessage({
        type: "selectPoint",
        point: pointName
    }, "*");

}

/* ================= LOOP ================= */

function animate(){
    requestAnimationFrame(animate);
    render();
}

function render(){
        renderer.render(scene,camera);
}

/* ================= START ================= */

init();
animate();

</script>
</body>
</html>
