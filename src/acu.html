<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Liaison Points d'Énergie</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { margin:0; overflow:hidden; font-family: monospace; background:#BD786C; }
        #pointLabel {
            position: absolute; left: 10px; top:50%;
            transform: translateY(-50%) rotate(-90deg);
            transform-origin: left top;
            background: transparent; color:#3a2d27;
            font-family: Arial, sans-serif; white-space: nowrap;
            z-index:9999; pointer-events:none;
        }
        #pointLabel .point-name { font-weight:bold; font-size:18px; margin-right:6px; }
        #pointLabel .copyright { font-size:11px; font-weight:normal; }
    </style>
</head>
<body>
<div id="pointLabel"></div>

<script src="three/build/three.js"></script>
<script src="three/loaders/OBJLoader.js"></script>
<script src="three/controls/OrbitControls.js"></script>

<script>
let container, camera, scene, renderer, controls;
let raycaster = new THREE.Raycaster();
let mouse = new THREE.Vector2();
let lastClickedPoint = null;
let focoCamera = false;
let acuX=0, acuY=0, acuZ=0, acuXF=0, acuYF=0, acuZF=0;
let p = new THREE.Vector3();

function init() {
    container = document.createElement('div');
    document.body.appendChild(container);

    // Caméra
    camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.5, 2000);
    camera.position.set(0,50,250);

    // Scène
    scene = new THREE.Scene();

    // Lumières
    scene.add(new THREE.AmbientLight(0x101030));
    const dir1 = new THREE.DirectionalLight(0xffeedd); dir1.position.set(0,0,1); scene.add(dir1);
    const dir2 = new THREE.DirectionalLight(0xffeedd); dir2.position.set(0,0,-1); scene.add(dir2);

    // Renderer
    renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setClearColor(0xBD786C);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);

    // OrbitControls
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableRotate = false;
    controls.enablePan = false;
    controls.enableZoom = true;

    // ⚡ Correction warning passive
    renderer.domElement.addEventListener('wheel', controls.onMouseWheel.bind(controls), { passive: false });

    // Gestion resize
    window.addEventListener('resize', onWindowResize);

    // Création sphère
    function createSphere(name, color, x, y, z, view=null){
        const geometry = new THREE.SphereGeometry(0.8,32,32);
        const material = new THREE.MeshLambertMaterial({color});
        const sphere = new THREE.Mesh(geometry, material);
        sphere.name = name;
        sphere.position.set(x,y,z);
        if(view!==null) sphere.view = view;
        scene.add(sphere);
    }

    // Tracer méridien
    function drawMeridianCurve(pointNames, colorHex){
        const points=[];
        pointNames.forEach(name=>{
            const obj=scene.getObjectByName(name);
            if(obj){
                const outward=obj.position.clone().normalize().multiplyScalar(0.8);
                points.push(obj.position.clone().add(outward));
            }
        });
        if(points.length<2) return;
        const curve=new THREE.CatmullRomCurve3(points,false,'catmullrom',0.5);
        const tubeGeom=new THREE.TubeGeometry(curve,300,0.3,8,false);
        const tubeMat=new THREE.MeshLambertMaterial({color: colorHex});
        const tube=new THREE.Mesh(tubeGeom,tubeMat);
        scene.add(tube);
    }

    // === POINTS MÉRIDIENS ===
    const meridians = {
        p: [
            {name:'p1',x:-13.27,y:46,z:-1.1},{name:'p2',x:-14.27,y:48.6,z:-4.6},{name:'p3',x:-22.97,y:32.4,z:-4.7},
            {name:'p4',x:-23.57,y:28.7,z:-5},{name:'p5',x:-24.17,y:15.7,z:-4.6},{name:'p6',x:-25.77,y:7.5,z:-2.7},
            {name:'p7',x:-26.97,y:-1.5,z:-1.5},{name:'p8',x:-26.27,y:-3.5,z:-0.5},{name:'p9',x:-27.37,y:-5.5,z:-0.3},
            {name:'p10',x:-27.67,y:-7.7,z:2.1},{name:'p11',x:-30.57,y:-13.2,z:6}
        ],
        gi: [
            {name:'gi1',x:29.23,y:-20,z:6,view:1},{name:'gi2',x:29.33,y:-14.7,z:2.8,view:1},
            {name:'gi3',x:29.53,y:-12.2,z:1.8,view:1},{name:'gi4',x:29.53,y:-10.5,z:0.4,view:-2},
            {name:'gi5',x:28.33,y:-6.8,z:0.4,view:1},{name:'gi6',x:28.03,y:-0.3,z:-3.8,view:1},
            {name:'gi7',x:27.83,y:4.4,z:-6.4,view:1},{name:'gi8',x:27.73,y:9.7,z:-8.1,view:1},
            {name:'gi9',x:27.53,y:12,z:-8.8,view:1},{name:'gi10',x:27.23,y:14.3,z:-9.3,view:1},
            {name:'gi11',x:27.03,y:17.6,z:-8.8,view:1},{name:'gi12',x:26.63,y:18.5,z:-8.6,view:1},
            {name:'gi13',x:26.43,y:23.5,z:-9.3,view:1},{name:'gi14',x:24.73,y:33.3,z:-7.6,view:1},
            {name:'gi15',x:20.43,y:47.2,z:-5,view:1},{name:'gi16',x:9.13,y:45.8,z:-17.48,view:1},
            {name:'gi17',x:5.53,y:54.1,z:-4,view:1},{name:'gi18',x:5.13,y:56.1,z:-3.6,view:1},
            {name:'gi19',x:0.93,y:62.4,z:4.9,view:1},{name:'gi20',x:1.93,y:62.9,z:4.3,view:1},
            {name:'gi21',x:-0.93,y:62.4,z:4.9,view:1},{name:'gi22',x:-1.93,y:62.9,z:4.3,view:1}
        ],
        e: [
            {name:'e1',x:-2.97,y:66.7,z:3},{name:'e2',x:-2.97,y:66,z:3.2},{name:'e3',x:-2.87,y:63.7,z:3.8},
            {name:'e4',x:-2.77,y:61.1,z:4.1},{name:'e5',x:-3.37,y:58.2,z:2.5,view:-1},{name:'e6',x:-5.97,y:61.3,z:-2.6,view:-1},
            {name:'e7',x:-6.47,y:64.2,z:-2.7,view:-1},{name:'e8',x:-6.27,y:71.9,z:-2.7,view:-1}
        ],
        vc: [
            {name:'vc1',x:0.05,y:-12.7,z:-4.2},{name:'vc2',x:0.05,y:-6,z:6.4},{name:'vc3',x:0.05,y:-2.9,z:7.1},
            {name:'vc4',x:0.05,y:0.2,z:7.17},{name:'vc5',x:0.05,y:3.3,z:7.25},{name:'vc6',x:0.05,y:6.4,z:7.3},
            {name:'vc7',x:0.05,y:9.5,z:7.2},{name:'vc8',x:0.05,y:12.7,z:6.1},{name:'vc9',x:0.05,y:15.9,z:6.1}
        ]
    };

    const colors = {p:0xffaa00, gi:0x00aaff, e:0xff00aa, vc:0xaaff00};

    // Création sphères et tracés
    for(const meridian in meridians){
        const points = meridians[meridian];
        points.forEach(pt=>createSphere(pt.name,colors[meridian],pt.x,pt.y,pt.z,pt.view));
        drawMeridianCurve(points.map(pt=>pt.name), colors[meridian]);
    }

    // Chargement OBJ + texture
    const loader = new THREE.TextureLoader();
    const texture = loader.load('three/textura/UV_Grid_Sm.jpg');
    const objLoader = new THREE.OBJLoader();
    objLoader.load('three/modelo/corpo.obj', obj=>{
        obj.traverse(c=>{
            if(c.isMesh) c.material.map = texture;
        });
        obj.position.y = -95;
        scene.add(obj);
    });

    // Clic sur points
    window.addEventListener('click', onDocumentClick);
}

// Resize
function onWindowResize(){
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

// Click
function onDocumentClick(event){
    mouse.x = (event.clientX/window.innerWidth)*2-1;
    mouse.y = -(event.clientY/window.innerHeight)*2+1;
    raycaster.setFromCamera(mouse,camera);
    const intersects = raycaster.intersectObjects(scene.children);
    if(intersects.length>0){
        const clicked = intersects[0].object;
        document.getElementById('pointLabel').innerHTML =
            `<span class="point-name">${clicked.name.toUpperCase()}</span> <span class="copyright">© bien-etre-geobiologie.fr</span>`;
        if(lastClickedPoint && lastClickedPoint!==clicked)
            lastClickedPoint.material.color.setHex(lastClickedPoint.originalColor);
        if(!clicked.originalColor) clicked.originalColor=clicked.material.color.getHex();
        clicked.material.color.setHex(0xFF0000);
        lastClickedPoint=clicked;

        // Focus caméra
        acuX=clicked.position.x; acuY=clicked.position.y; acuZ=clicked.position.z;
        if(clicked.view===undefined) acuZF=45;
        else if(clicked.view===1) acuXF=45;
        else if(clicked.view===-1) acuXF=-45;
        else if(clicked.view===-2) acuZF=-45;
        p.set(acuX,acuY,acuZ); focoCamera=true;

        // Post message pour parent
        window.parent.postMessage({type:'selectPoint',point:clicked.name},'*');
    }
}

function animate(){
    requestAnimationFrame(animate);
    render();
}

function render(){
    renderer.render(scene,camera);
    if(focoCamera){
        camera.position.x+=(acuX+acuXF-camera.position.x)/10;
        camera.position.y+=(acuY-camera.position.y)/10;
        camera.position.z+=(acuZ+acuZF-camera.position.z)/10;
        camera.lookAt(p);
        if(Math.round(camera.position.x)===Math.round(acuX+acuXF) &&
           Math.round(camera.position.y)===Math.round(acuY) &&
           Math.round(camera.position.z)===Math.round(acuZ+acuZF)){
            acuXF=acuYF=acuZF=0;
            focoCamera=false;
            controls.target.set(p.x,p.y,p.z);
        }
    }
}

// Lancer
init();
animate();
</script>
</body>
</html>
