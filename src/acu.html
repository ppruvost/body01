<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Liaison Points d'Énergie</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { margin:0; overflow:hidden; font-family: monospace; background:#BD786C; }
        #pointLabel {
            position: absolute; left: 10px; top:50%;
            transform: translateY(-50%) rotate(-90deg);
            transform-origin: left top;
            background: transparent; color:#3a2d27;
            font-family: Arial, sans-serif; white-space: nowrap;
            z-index:9999; pointer-events:none;
        }
        #pointLabel .point-name { font-weight:bold; font-size:18px; margin-right:6px; }
        #pointLabel .copyright { font-size:11px; font-weight:normal; }
    </style>
</head>
<body>
    <div id="pointLabel"></div>
    <script src="three/build/three.js"></script>
    <script src="three/loaders/OBJLoader.js"></script>
    <script src="three/controls/OrbitControls.js"></script>

    <script>
        let container, camera, scene, renderer, controls;
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        let lastClickedPoint = null;
        let focoCamera = false;
        let acuX=0, acuY=0, acuZ=0, acuXF=0, acuYF=0, acuZF=0;
        let p = new THREE.Vector3(0,0,0);
        let obj_aux = null;

        function init() {
            container = document.createElement('div');
            document.body.appendChild(container);

            // Caméra
            camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.5, 2000);
            camera.position.z = 250;

            // Scène
            scene = new THREE.Scene();

            // Lumières
            scene.add(new THREE.AmbientLight(0x101030));
            const dir1 = new THREE.DirectionalLight(0xffeedd); dir1.position.set(0,0,1); scene.add(dir1);
            const dir2 = new THREE.DirectionalLight(0xffeedd); dir2.position.set(0,0,-1); scene.add(dir2);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias:true });
            renderer.setClearColor(0xBD786C);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            // OrbitControls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableRotate = false;
            controls.enablePan = false;
            controls.enableZoom = true;

            // ⚡ Correction warning passive
            renderer.domElement.addEventListener(
                'wheel',
                controls.onMouseWheel.bind(controls),
                { passive: false }
            );

            // Gestion du resize
            window.addEventListener('resize', onWindowResize);

            // Fonction création sphère
            function createSphere(name, color, x, y, z, view=null) {
                const geometry = new THREE.SphereGeometry(0.3,32,32);
                const material = new THREE.MeshLambertMaterial({ color });
                const sphere = new THREE.Mesh(geometry, material);
                sphere.name = name;
                sphere.position.set(x,y,z);
                if(view!==null) sphere.view = view;
                scene.add(sphere);
            }

            // Fonction pour tracer méridien
            function drawMeridianCurve(pointNames, colorHex) {
                const points=[];
                pointNames.forEach(name=>{
                    const obj=scene.getObjectByName(name);
                    if(obj){
                        const outward=obj.position.clone().normalize().multiplyScalar(0.8);
                        points.push(obj.position.clone().add(outward));
                    }
                });
                if(points.length<2) return;
                const curve=new THREE.CatmullRomCurve3(points,false,'catmullrom',0.5);
                const tubeGeom=new THREE.TubeGeometry(curve,300,0.15,16,false);
                const tubeMat=new THREE.MeshLambertMaterial({color: colorHex});
                const tube=new THREE.Mesh(tubeGeom,tubeMat);
                scene.add(tube);
            }

            // === POINTS MÉRIDIENS ===
            const meridians = {
                // Poumon
                p: [
                    {name:'p1',x:-13.267798,y:46,z:-1.1},
                    {name:'p2',x:-14.267798,y:48.6,z:-4.6},
                    {name:'p3',x:-22.967798,y:32.4,z:-4.7},
                    {name:'p4',x:-23.567798,y:28.7,z:-5},
                    {name:'p5',x:-24.167798,y:15.7,z:-4.6},
                    {name:'p6',x:-25.767798,y:7.5,z:-2.7},
                    {name:'p7',x:-26.967798,y:-1.5,z:-1.5},
                    {name:'p8',x:-26.267798,y:-3.5,z:-0.5},
                    {name:'p9',x:-27.367798,y:-5.5,z:-0.3},
                    {name:'p10',x:-27.667798,y:-7.7,z:2.1},
                    {name:'p11',x:-30.567798,y:-13.2,z:6}
                ],
                // Gros Intestin
                gi: [
                    {name:'gi1',x:29.2322,y:-20,z:6,view:1},{name:'gi2',x:29.3322,y:-14.7,z:2.8,view:1},
                    {name:'gi3',x:29.5322,y:-12.2,z:1.8,view:1},{name:'gi4',x:29.5322,y:-10.5,z:0.4,view:-2},
                    {name:'gi5',x:28.3322,y:-6.8,z:0.4,view:1},{name:'gi6',x:28.0322,y:-0.3,z:-3.8,view:1},
                    {name:'gi7',x:27.8322,y:4.4,z:-6.4,view:1},{name:'gi8',x:27.7322,y:9.7,z:-8.1,view:1},
                    {name:'gi9',x:27.5322,y:12,z:-8.8,view:1},{name:'gi10',x:27.2322,y:14.3,z:-9.3,view:1},
                    {name:'gi11',x:27.0322,y:17.6,z:-8.8,view:1},{name:'gi12',x:26.6322,y:18.5,z:-8.6,view:1},
                    {name:'gi13',x:26.4322,y:23.5,z:-9.3,view:1},{name:'gi14',x:24.7322,y:33.3,z:-7.6,view:1},
                    {name:'gi15',x:20.4322,y:47.2,z:-5,view:1},{name:'gi16',x:9.1322,y:45.8,z:-17.48,view:1},
                    {name:'gi17',x:5.5322,y:54.1,z:-4,view:1},{name:'gi18',x:5.1322,y:56.1,z:-3.6,view:1},
                    {name:'gi19',x:0.9322,y:62.4,z:4.9,view:1},{name:'gi20',x:1.9322,y:62.9,z:4.3,view:1},
                    {name:'gi21',x:-0.9322,y:62.4,z:4.9,view:1},{name:'gi22',x:-1.9322,y:62.9,z:4.3,view:1}
                ],
                // Estomac
                e: [
                {name:'e1',x:-2.9678,y:66.7,z:3},{name:'e2',x:-2.9678,y:66,z:3.2},{name:'e3',x:-2.8678,y:63.7,z:3.8},
                {name:'e4',x:-2.7678,y:61.1,z:4.1},{name:'e5',x:-3.3678,y:58.2,z:2.5,view:-1}
                { name: 'e6', x: -5.967798006864511, y: 61.30000000000026, z: -2.6000000000000028, view: -1 },
                { name: 'e7', x: -6.467798006864509, y: 64.20000000000029, z: -2.700000000000003, view: -1 },
                { name: 'e8', x: -6.26779800686451, y: 71.89999999999985, z: -2.700000000000003, view: -1 },
                { name: 'e9', x: -2.9677980068645167, y: 54.20000000000016, z: -2.3000000000000025 },
                { name: 'e10', x: -2.267798006864516, y: 51.40000000000012, z: -2.2000000000000024 },
                { name: 'e11', x: -2.9677980068645167, y: 47.600000000000065, z: -1.2000000000000015 },
                { name: 'e12', x: -6.667798006864508, y: 48.60000000000008, z: -2.2000000000000024 },
                { name: 'e13', x: -7.067798006864507, y: 47.600000000000065, z: -1.0000000000000013 },
                { name: 'e14', x: -7.667798006864505, y: 44.800000000000026, z: 0.8999999999999986 },
                { name: 'e15', x: -8.767798006864501, y: 42.29999999999999, z: 2.3999999999999995 },
                { name: 'e16', x: -9.867798006864497, y: 38.89999999999994, z: 4.2 },
                { name: 'e17', x: -12.06779800686449, y: 33.19999999999986, z: 4.999999999999997 },
                { name: 'e18', x: -12.06779800686449, y: 30.199999999999818, z: 2.1999999999999993 },
                { name: 'e19', x: -3.167798006864517, y: 25.699999999999754, z: 6.599999999999992 },
                { name: 'e20', x: -3.167798006864517, y: 22.64727272727248, z: 6.699999999999991 },
                { name: 'e21', x: -3.167798006864517, y: 19.59454545454521, z: 6.699999999999991 },
                { name: 'e22', x: -3.167798006864517, y: 16.541818181817938, z: 6.499999999999992 },
                { name: 'e23', x: -3.167798006864517, y: 13.489090909090663, z: 6.699999999999991 },
                { name: 'e24', x: -3.167798006864517, y: 10.43636363636339, z: 7.09999999999999 },
                { name: 'e25', x: -3.167798006864517, y: 7.383636363636118, z: 6.99999999999999 },
                { name: 'e26', x: -3.167798006864517, y: 4.330909090908847, z: 6.899999999999991 },
                { name: 'e27', x: -3.167798006864517, y: 1.2781818181815723, z: 6.599999999999992 },
                { name: 'e28', x: -3.167798006864517, y: -1.7745454545457022, z: 6.299999999999993 },
                { name: 'e29', x: -3.167798006864517, y: -4.827272727272973, z: 5.699999999999995 },
                { name: 'e30', x: -3.167798006864517, y: -7.880000000000244, z: 4.599999999999999 },
                { name: 'e31', x: -12.467798006864488, y: -11.280000000000232, z: 4.100000000000001 },
                { name: 'e32', x: -12.467798006864488, y: -28.48000000000039, z: 4.300000000000001 },
                { name: 'e33', x: -12.467798006864488, y: -36.2800000000005, z: 2.900000000000001 },
                { name: 'e34', x: -12.467798006864488, y: -38.98000000000054, z: 2.3000000000000003 },
                { name: 'e35', x: -12.467798006864488, y: -47.18000000000065, z: 1.4999999999999996 },
                { name: 'e36', x: -12.467798006864488, y: -53.18000000000074, z: -0.10000000000000153 },
                { name: 'e37', x: -12.467798006864488, y: -63.68000000000089, z: -0.7000000000000015 },
                { name: 'e38', x: -11.76779800686449, y: -69.78000000000057, z: -1.6000000000000019 },
                { name: 'e39', x: -11.367798006864492, y: -73.28000000000037, z: -1.9000000000000021 },
                { name: 'e40', x: -13.467798006864484, y: -69.48000000000059, z: -4.3000000000000025, view: -1 },
                { name: 'e41', x: -8.667798006864501, y: -85.1799999999997, z: -0.8000000000000016 },
                { name: 'e42', x: -9.967798006864497, y: -88.27999999999952, z: 0.9999999999999983 },
                { name: 'e43', x: -8.8677980068645, y: -90.97999999999936, z: 6.099999999999993 },
                { name: 'e44', x: -9.467798006864498, y: -91.87999999999931, z: 7.799999999999988 },
                { name: 'e45', x: -9.967798006864497, y: -93.17999999999924, z: 11.299999999999976 }
                ],
                // Vaisseau Conception
                vc: [
                {name:'vc1',x:0.05,y:-12.7,z:-4.2},{name:'vc2',x:0.05,y:-6,z:6.4},{name:'vc3',x:0.05,y:-2.9,z:7.1},
                {name:'vc4',x:0.05,y:0.2,z:7.17},{name:'vc5',x:0.05,y:3.3,z:7.25}
                { name: 'vc6', x: 0.05, y: 6.4, z: 7.3 },
                { name: 'vc7', x: 0.05, y: 9.5, z: 7.2 },
                { name: 'vc8', x: 0.05, y: 12.7, z: 6.1 },
                { name: 'vc9', x: 0.05, y: 15.9, z: 6.1 },
                { name: 'vc10', x: 0.05, y: 18.4, z: 6.38 },
                { name: 'vc11', x: 0.05, y: 20.9, z: 6.38 },
                { name: 'vc12', x: 0.05, y: 23.4, z: 6.58 },
                { name: 'vc13', x: 0.05, y: 25.9, z: 6.6 },
                { name: 'vc14', x: 0.05, y: 28.4, z: 5.95 },
                { name: 'vc15', x: 0.05, y: 30.9, z: 5.06 },
                { name: 'vc16', x: 0.05, y: 33.4, z: 4.9 },
                { name: 'vc17', x: 0.05, y: 36, z: 4.7 },
                { name: 'vc18', x: 0.05, y: 38.6, z: 3.6 },
                { name: 'vc19', x: 0.05, y: 41.2, z: 2.4 },
                { name: 'vc20', x: 0.05, y: 43.8, z: 1.2 },
                { name: 'vc21', x: 0.05, y: 46.4, z: -0.9 },
                { name: 'vc22', x: 0.05, y: 49, z: -2.1 },
                { name: 'vc23', x: 0.02, y: 56, z: -0.2 },
                { name: 'vc24', x: 0.02, y: 60, z: 5 }
                ]
            };

            // Création sphères et tracés
            for(const meridian in meridians){
                const points = meridians[meridian];
                points.forEach(p=>createSphere(p.name,p.color||0xffffff,p.x,p.y,p.z,p.view));
                drawMeridianCurve(points.map(pt=>pt.name), points[0].color||0xffffff);
            }

            // Chargement OBJ + texture
            const manager = new THREE.LoadingManager();
            const texture = new THREE.Texture();
            new THREE.ImageLoader(manager).load('three/textura/UV_Grid_Sm.jpg', img=>{texture.image=img;texture.needsUpdate=true;});
            new THREE.OBJLoader(manager).load('three/modelo/corpo.obj', obj=>{
                obj.traverse(c=>{if(c instanceof THREE.Mesh)c.material.map=texture;});
                obj.position.y=-95;
                scene.add(obj);
            });

            // Clic sur points
            window.addEventListener('click', onDocumentClick);
        }

        // Gestion du resize
        function onWindowResize(){
            camera.aspect=window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Clic sur points
        function onDocumentClick(event){
            event.preventDefault();
            mouse.x=(event.clientX/window.innerWidth)*2-1;
            mouse.y=-(event.clientY/window.innerHeight)*2+1;
            raycaster.setFromCamera(mouse,camera);
            const intersects=raycaster.intersectObjects(scene.children);
            if(intersects.length>0){
                const clicked=intersects[0].object;
                document.getElementById('pointLabel').innerHTML=
                    `<span class="point-name">${clicked.name.toUpperCase()}</span> <span class="copyright">© bien-etre-geobiologie.fr</span>`;
                if(lastClickedPoint && lastClickedPoint!==clicked)
                    lastClickedPoint.material.color.setHex(lastClickedPoint.originalColor);
                if(!clicked.originalColor) clicked.originalColor=clicked.material.color.getHex();
                clicked.material.color.setHex(0xFF0000);
                lastClickedPoint=clicked;

                // Focus caméra
                acuX=clicked.position.x; acuY=clicked.position.y; acuZ=clicked.position.z;
                if(clicked.view===undefined) acuZF=45;
                else if(clicked.view===1) acuXF=45;
                else if(clicked.view===-1) acuXF=-45;
                else if(clicked.view===-2) acuZF=-45;
                p.set(acuX,acuY,acuZ); focoCamera=true;

                // Post message pour parent
                window.parent.postMessage({type:'selectPoint',point:clicked.name},'*');
            }
        }

        function animate(){
            requestAnimationFrame(animate);
            render();
        }

        function render(){
            renderer.render(scene,camera);
            if(focoCamera){
                camera.position.x+=(acuX+acuXF-camera.position.x)/10;
                camera.position.y+=(acuY-camera.position.y)/10;
                camera.position.z+=(acuZ+acuZF-camera.position.z)/10;
                camera.lookAt(p);
                if(Math.round(camera.position.x)===Math.round(acuX+acuXF) &&
                   Math.round(camera.position.y)===Math.round(acuY) &&
                   Math.round(camera.position.z)===Math.round(acuZ+acuZF)){
                    acuXF=acuYF=acuZF=0;
                    focoCamera=false;
                    controls.target.set(p.x,p.y,p.z);
                }
            }
        }

        // Lancer l'init
        init();
        animate();
    </script>
</body>
</html>
